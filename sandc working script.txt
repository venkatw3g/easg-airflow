terraform {
  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "=3.0.0"  # Adjust version as needed
    }
  }
}

provider "azurerm" {
  features {}

  client_id       = "417b1d94-c7ef-49b6-bf9a-33db3eeedcc4"  # Your Service Principal Client ID
  client_secret   = "vrk8Q~2abFJqWM2SLodQwzWqw2rtkBwrPZF5ecpC"  # Your Service Principal Client Secret
  tenant_id       = "21c4b724-f908-455e-813c-11c8d17f3e9a"  # Your Tenant ID
  subscription_id = "51d20b7c-190d-4c61-ae49-5c3a32252a63"  # Your Subscription ID
}
#create resource group
resource "azurerm_resource_group" "rg" {
    name     = "${var.rgname}"
    location = "${var.location}"
    tags      = {
        Environment = "Terraform Demo"
    }
}

resource "azurerm_data_factory" "example" {
  name                = "${var.data_factory}"
  location            = azurerm_resource_group.rg.location
  resource_group_name = azurerm_resource_group.rg.name
}

resource "azurerm_databricks_workspace" "example" {
  name                          = "${var.databricks_workspace}"
  resource_group_name           = azurerm_resource_group.rg.name
  location                      = azurerm_resource_group.rg.location
  sku                           = "premium"  # Set to Premium SKU as required
  managed_resource_group_name   = "${var.databricks_mrg}"  # Define or replace with an appropriate variable
  virtual_network_subnet_id     = azurerm_subnet.subnet1.id  # Ensure the subnet ID is specified for vNet injection
  public_network_access_enabled = false  # Disables public IP as required
  infrastructure_encryption_enabled = true  # Enables infrastructure encryption
}

resource "azurerm_key_vault" "example" {
  name                        = "${var.key_vault}"
  location                    = azurerm_resource_group.rg.location
  resource_group_name         = azurerm_resource_group.rg.name
  enabled_for_disk_encryption = true
  tenant_id                   = "21c4b724-f908-455e-813c-11c8d17f3e9a"  # Replace tenant_id here
  soft_delete_retention_days  = 7
  purge_protection_enabled    = false

  sku_name = "standard"

  access_policy {
    tenant_id = "21c4b724-f908-455e-813c-11c8d17f3e9a"  # Replace tenant_id here
    object_id = "40136d3f-1189-49d9-aff3-bba98ea1ebc9"  # Replace object_id here

    key_permissions = [
      "Get",
    ]

    secret_permissions = [
      "Get",
    ]

    storage_permissions = [
      "Get",
    ]
  }
}


resource "azurerm_storage_account" "example" {
  name                     = "${var.storage_account}"
  resource_group_name      = azurerm_resource_group.rg.name
  location                 = azurerm_resource_group.rg.location
  account_tier             = "Standard"
  account_replication_type = "LRS"

}

resource "azurerm_storage_container" "example" {
  name                  = "${var.container_name}"
  storage_account_name  = azurerm_storage_account.example.name
  container_access_type = "private"
}


resource "azurerm_virtual_network" "vnet1" {
  name                = "${var.prefix}-10"
  resource_group_name = "${azurerm_resource_group.rg.name}"
  location            = "${azurerm_resource_group.rg.location}"
  address_space       = ["${var.vnet_cidr_prefix}"]
}

resource "azurerm_subnet" "subnet1" {
  name                 = "subnet1"
  virtual_network_name = "${azurerm_virtual_network.vnet1.name}"
  resource_group_name  = "${azurerm_resource_group.rg.name}"
  address_prefixes     = ["${var.subnet1_cidr_prefix}"]
}

resource "azurerm_network_security_group" "nsg1" {
  name                = "${var.prefix}-nsg1"
  resource_group_name = "${azurerm_resource_group.rg.name}"
  location            = "${azurerm_resource_group.rg.location}"
}

# NOTE: this allows RDP from any network
resource "azurerm_network_security_rule" "rdp" {
  name                        = "rdp"
  resource_group_name         = "${azurerm_resource_group.rg.name}"
  network_security_group_name = "${azurerm_network_security_group.nsg1.name}"
  priority                    = 102
  direction                   = "Inbound"
  access                      = "Allow"
  protocol                    = "Tcp"
  source_port_range           = "*"
  destination_port_range      = "3389"
  source_address_prefix       = "*"
  destination_address_prefix  = "*"
}

resource "azurerm_subnet_network_security_group_association" "nsg_subnet_assoc" {
  subnet_id                 = azurerm_subnet.subnet1.id
  network_security_group_id = azurerm_network_security_group.nsg1.id
}

resource "azurerm_network_interface" "nic1" {
  name                = "${var.prefix}-nic"
  resource_group_name = azurerm_resource_group.rg.name
  location            = azurerm_resource_group.rg.location

  ip_configuration {
    name                          = "internal"
    subnet_id                     = azurerm_subnet.subnet1.id
    private_ip_address_allocation = "Dynamic"
  }
}

resource "azurerm_windows_virtual_machine" "main" {
  name                            = "${var.prefix}-vmt01"  # VM name can still be long
  resource_group_name             = azurerm_resource_group.rg.name
  location                        = azurerm_resource_group.rg.location
  size                            = "Standard_B1s"
  admin_username                  = "adminuser"
  admin_password                  = "P@ssw0rd1234!"
  network_interface_ids           = [azurerm_network_interface.nic1.id]

  # Dynamically shorten computer_name to 15 characters if needed
  computer_name                   = "shortname01"

  source_image_reference {
    publisher = "MicrosoftWindowsServer"
    offer     = "WindowsServer"
    sku       = "2012-R2-Datacenter"
    version   = "latest"
  }

  os_disk {
    storage_account_type = "Standard_LRS"
    caching              = "ReadWrite"
  }
}

# Private Endpoint for Blob
resource "azurerm_private_endpoint" "storage_blob_pe" {
  name                = "${var.prefix}-storage-blob-pe"
  location            = azurerm_resource_group.rg.location
  resource_group_name = azurerm_resource_group.rg.name
  subnet_id           = azurerm_subnet.subnet1.id

  private_service_connection {
    name                           = "blob-connection"
    private_connection_resource_id = azurerm_storage_account.example.id
    subresource_names              = ["blob"]
    is_manual_connection           = false
  }
}

# Network Interface for Blob Private Endpoint
resource "azurerm_network_interface" "storage_blob_pe_nic" {
  name                = "${var.prefix}-blob-pe-nic"
  location            = azurerm_resource_group.rg.location
  resource_group_name = azurerm_resource_group.rg.name
  ip_configuration {
    name                          = "internal"
    subnet_id                     = azurerm_subnet.subnet1.id
    private_ip_address_allocation = "Dynamic"
  }
}

# Private Endpoint for DFS
resource "azurerm_private_endpoint" "storage_dfs_pe" {
  name                = "${var.prefix}-storage-dfs-pe"
  location            = azurerm_resource_group.rg.location
  resource_group_name = azurerm_resource_group.rg.name
  subnet_id           = azurerm_subnet.subnet1.id

  private_service_connection {
    name                           = "dfs-connection"
    private_connection_resource_id = azurerm_storage_account.example.id
    subresource_names              = ["dfs"]
    is_manual_connection           = false
  }
}

# Network Interface for DFS Private Endpoint
resource "azurerm_network_interface" "storage_dfs_pe_nic" {
  name                = "${var.prefix}-dfs-pe-nic"
  location            = azurerm_resource_group.rg.location
  resource_group_name = azurerm_resource_group.rg.name
  ip_configuration {
    name                          = "internal"
    subnet_id                     = azurerm_subnet.subnet1.id
    private_ip_address_allocation = "Dynamic"
  }
}



key_vault

resource "azurerm_key_vault" "example" {
  name                        = "${var.key_vault}"
  location                    = azurerm_resource_group.rg.location
  resource_group_name         = azurerm_resource_group.rg.name
  enabled_for_disk_encryption = true
  tenant_id                   = "21c4b724-f908-455e-813c-11c8d17f3e9a"  # Replace tenant_id here
  soft_delete_retention_days  = 7
  purge_protection_enabled    = false

  sku_name = "standard"

  access_policy {
    tenant_id = "21c4b724-f908-455e-813c-11c8d17f3e9a"  # Replace tenant_id here
    object_id = "40136d3f-1189-49d9-aff3-bba98ea1ebc9"  # Replace object_id here

    key_permissions = [
      "Get",
    ]

    secret_permissions = [
      "Get",
    ]

    storage_permissions = [
      "Get",
    ]
  }
}